---

name: CI pipeline for mpi-pytest

on:
  push:
  pull_request:
  schedule:
    - cron: '1 5 * * 1'

jobs:

  tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python: ['3.9', '3.10', '3.11', '3.12', '3.13']
    defaults:
      run:
        shell: bash -l {0}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Conda environment with Micromamba
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-file: ".github/etc/test_environment_mpich.yml"
          create-args: >-
              python=${{ matrix.python }}
      - name: Install mpi-pytest as a package in the current environment
        run: |
          pip install --no-deps -e .
      - name: Run tests
        run: |
          pytest --continue-on-collection-errors -v tests

  tests-macos:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        python: ['3.9', '3.10', '3.11', '3.12', '3.13']
    defaults:
      run:
        shell: bash -l {0}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Conda environment with Micromamba
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-file: ".github/etc/test_environment_mpich.yml"
          create-args: >-
              python=${{ matrix.python }}
      - name: Install mpi-pytest as a package in the current environment
        run: |
          pip install --no-deps -e .
      - name: Run tests
        run: |
          pytest --continue-on-collection-errors -v tests

  tests-firedrake:
    runs-on: ubuntu-latest
    container:
      image: firedrakeproject/firedrake-vanilla-default:latest
      options: --user root
      volumes:
        - ${{ github.workspace }}:/repositories
    defaults:
      run:
        shell: bash -l {0}
    steps:
      - name: Fix HOME
        # For unknown reasons GitHub actions overwrite HOME to /github/home
        # which will break everything unless fixed
        # (https://github.com/actions/runner/issues/863)
        run: echo "HOME=/home/firedrake" >> "$GITHUB_ENV"
      - name: Checkout mpi-pytest
        uses: actions/checkout@v4
        with: 
          path: ./mpi-pytest
      - name: Print MPI version
        run: mpiexec --version
      - name: Create virtual environment
        # pass '--system-site-packages' so Firedrake can be found
        run: python3 -m venv --system-site-packages my_venv
      - name: Install mpi-pytest as a package in the current environment
        run: |
          . my_venv/bin/activate
          pip install --no-deps -e ./mpi-pytest
      - name: Run tests
        run: |
          . my_venv/bin/activate
          pytest --continue-on-collection-errors -v ./mpi-pytest/tests
